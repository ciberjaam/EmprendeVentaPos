<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmprendeVenta POS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5"/>
    <!-- Corrige la referencia al fichero de manifiesto PWA (nombre en minúsculas) -->
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-accent: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #d1d5db;
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-color-hover: #4338ca; /* Indigo 700 */
            --header-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            --card-shadow: 0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px -1px rgba(0,0,0,0.07);
            /* Use a very opaque overlay for modals.  An opacity of 0.9 hides
               most of the underlying content, ensuring that confirmation and
               WhatsApp dialogs are the visual focus and no transparency
               distracts the user. */
            --modal-overlay: rgba(17, 24, 39, 0.9);
        }
        html.dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-accent: #374151;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --border-color: #4b5563;
            --primary-color: #6366f1; /* Indigo 500 */
            --primary-color-hover: #4f46e5; /* Indigo 600 */
            --header-shadow: 0 1px 2px 0 rgba(0,0,0,0.25);
            --card-shadow: 0 1px 3px 0 rgba(0,0,0,0.4), 0 1px 2px -1px rgba(0,0,0,0.4);
            /* Dark mode overlay nearly opaque for modals to minimise
               transparency.  A value of 0.85 dims the background while
               allowing some subtle context. */
            --modal-overlay: rgba(0, 0, 0, 0.85);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); -webkit-tap-highlight-color: transparent; }
        .header { background-color: var(--bg-secondary); box-shadow: var(--header-shadow); border-bottom: 1px solid var(--border-color); }
        .drawer { transition: transform 0.3s ease-in-out; background-color: var(--bg-secondary); }
        .drawer.open { transform: translateX(0); } .drawer.closed { transform: translateX(100%); }
        /*
         * Overlay background for modals.  In addition to the theme‑dependent
         * colour defined by `--modal-overlay`, we add a slight blur to the
         * backdrop to improve contrast and focus on the modal content.  This
         * resolves issues where confirm and WhatsApp choice dialogues appear
         * overly transparent and distracting.
         */
        .modal-overlay-bg {
            /* Use a solid overlay colour without blur.  Transparency was
               removed because users found semi‑transparent modals
               distracting.  The overlay colour and opacity are defined
               in the CSS variables above. */
            background-color: var(--modal-overlay);
        }

        .btn { @apply font-bold py-2 px-4 rounded-lg transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-color-hover); }
        .btn-secondary { @apply bg-gray-200 text-gray-800 hover:bg-gray-300; }
        .btn-danger { @apply bg-red-600 text-white hover:bg-red-700; }
        .btn-text { @apply bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700; }
        html.dark .btn-secondary { @apply bg-gray-700 text-gray-200 hover:bg-gray-600; }
        
        .modal-input {
            @apply mt-1 block w-full px-3 py-2 border rounded-md shadow-sm;
            @apply bg-gray-50 border-gray-300 text-gray-900;
            @apply dark:bg-gray-700 dark:border-gray-600 dark:text-white;
            @apply focus:outline-none focus:ring-2;
            --tw-ring-color: var(--primary-color);
            border-color: var(--border-color);
        }

        .modal-content > div, .modal-content > form {
            background-color: var(--bg-secondary);
        }
        
        /* New Filter Bar Styles */
        #category-filters {
            background-color: #374151; /* gray-700 */
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        html.dark #category-filters {
            background-color: #1f2937; /* gray-800 */
        }
        .category-btn {
            @apply px-3 py-1 border-0 rounded-md text-sm transition-colors font-medium;
            color: #d1d5db; /* gray-300 */
            background-color: transparent;
        }
        .category-btn:not(.active):hover {
            background-color: #4b5563; /* gray-600 */
            color: #f9fafb; /* gray-50 */
        }
        .category-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }

        /* Limit the width of the displayed user email to prevent horizontal
           scrolling on small devices.  The label is hidden entirely on
           small screens using the `hidden sm:inline-block` classes in the
           markup.  This ensures that long email addresses do not distort
           the header layout. */
        #user-email-label {
            max-width: 10rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        @media (max-width: 640px) {
            #user-email-label {
                display: none;
            }
        }
       
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        #product-grid.list-view { grid-template-columns: 1fr !important; }
        #product-grid.list-view .product-card { flex-direction: row; align-items: center; }
        #product-grid.list-view .product-card .product-image-container { width: 6rem; height: 6rem; flex-shrink: 0; }
        #product-grid.list-view .product-card .product-info-container { flex-grow: 1; padding-left: 1rem; text-align: left;}
        
        .prose { max-width: none; }
    </style>
</head>
<body class="antialiased">

    <div id="config-error" class="hidden fixed inset-0 bg-red-100 text-red-800 p-8 text-center z-50 flex items-center justify-center">
         <div class="bg-white p-8 rounded-lg shadow-2xl max-w-lg">
             <h2 class="text-2xl font-bold mb-4">Error de Configuración</h2>
             <p>Por favor, introduce tu URL y ANON KEY de Supabase en las constantes dentro del script para que la aplicación pueda funcionar.</p>
         </div>
    </div>
    <div id="db-setup-error" class="hidden fixed inset-0 bg-yellow-100 text-yellow-800 p-8 z-50 flex items-center justify-center">
         <div class="bg-white p-8 rounded-lg shadow-2xl max-w-2xl text-left">
             <h2 class="text-2xl font-bold mb-4 text-gray-800">Acción Requerida: Configurar Base de Datos</h2>
             <p class="mb-4 text-gray-700">La aplicación no pudo encontrar las tablas necesarias. Por favor, ejecuta el siguiente script en el <strong>SQL Editor</strong> de tu proyecto de Supabase para configurar la base de datos.</p>
             <div class="relative bg-gray-900 text-white p-4 rounded-md text-sm font-mono max-h-64 overflow-auto">
                 <button id="copy-sql-btn" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded text-xs">Copiar</button>
                 <pre id="sql-script-to-copy" class="whitespace-pre-wrap"></pre>
             </div>
             <p class="mt-4 text-gray-600 text-sm">Después de ejecutar el script, <strong>refresca esta página</strong>.</p>
         </div>
    </div>

    <div id="app" class="pb-20">
        <header class="header sticky top-0 z-20 p-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="logo.png" alt="EmprendeVenta POS Logo" class="h-10">
                <h1 class="text-xl font-bold text-text-primary hidden sm:block">EmprendeVenta POS</h1>
            </div>
            <div class="flex items-center space-x-2">
                <input type="search" id="search-input" placeholder="Buscar producto..." class="border rounded-lg py-1.5 px-3 w-32 md:w-64 focus:outline-none focus:ring-2 bg-gray-50 dark:bg-gray-700 border-border-color" style="--tw-ring-color: var(--primary-color);">
                <button id="install-app-btn" class="hidden btn btn-secondary text-sm p-2 h-10 flex items-center gap-2"><i class="fas fa-download"></i> Instalar</button>
                <button id="theme-toggle-btn" class="p-2 w-10 h-10 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center justify-center">
                    <i class="fas fa-moon text-gray-600 dark:text-gray-300"></i>
                </button>
                <button id="auth-button" class="p-2 w-10 h-10 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center justify-center" title="">
                    <svg id="auth-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </button>
                <!-- Display the currently logged in user's email.  On small screens this
                     element remains hidden to preserve layout, but on larger
                     screens the email provides clear context about which
                     account is active.  It will be populated dynamically in
                     lockUIBySession(). -->
                <span id="user-email-label" class="hidden sm:inline-block text-sm text-gray-600 dark:text-gray-300 truncate max-w-xs"></span>
            </div>
        </header>

        <main class="p-4">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h2 class="text-2xl font-bold">Catálogo</h2>
                <div class="flex items-center gap-2 flex-wrap">
                    <button id="view-toggle-btn" class="btn btn-secondary p-2 h-10 w-10" title="Cambiar vista">
                        <i class="fas fa-grip-vertical"></i>
                    </button>
                    <button id="btn-manage-products" class="btn btn-primary flex items-center gap-1 py-2 px-3 rounded-md text-sm" title="Gestionar catálogo">
                        <i class="fas fa-boxes-stacked"></i>
                        <!-- Hide text on very small screens to improve layout.  The text becomes visible on small (sm) and larger screens. -->
                        <span class="hidden sm:inline">Catalogo</span>
                    </button>
                    <!-- Botón para que el administrador cree vendedores directamente desde la app -->
                    <button id="btn-create-seller" class="btn btn-primary flex items-center gap-1 py-2 px-3 rounded-md text-sm" title="Crear vendedor">
                        <i class="fas fa-user-plus"></i>
                        <span class="hidden sm:inline">Vendedor</span>
                    </button>
                    <!-- Botón para gestionar vendedores: listar, editar o eliminar -->
                    <button id="btn-manage-sellers" class="btn btn-primary flex items-center gap-1 py-2 px-3 rounded-md text-sm" title="Gestionar vendedores">
                        <i class="fas fa-users"></i>
                        <span class="hidden sm:inline">Vendedores</span>
                    </button>
                </div>
            </div>
            <div id="category-filters" class="mb-4 flex gap-2 overflow-x-auto pb-2"></div>
            <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            <p id="no-products-msg" class="text-center text-text-secondary mt-8 hidden">No se encontraron productos.</p>
        </main>

        <div class="fixed bottom-4 right-4 z-20">
            <button id="cart-button" class="text-white rounded-full p-4 shadow-lg flex items-center justify-center" style="background-color: var(--primary-color);">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-item-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
        </div>
    </div>

    <aside id="cart-drawer" class="drawer closed fixed top-0 right-0 h-full w-full max-w-sm shadow-2xl z-40 flex flex-col">
         <div class="flex items-center justify-between p-4 border-b border-border-color">
            <h3 class="text-xl font-bold">Carrito de Compras</h3>
            <button id="close-cart-button" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <div id="cart-items" class="flex-grow p-4 overflow-y-auto"></div>
        <div id="cart-footer" class="p-4 border-t border-border-color bg-bg-accent">
             <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                     <label for="exchange_rate" class="font-semibold">Tasa Bs:</label>
                     <button id="bcv-toggle-btn" class="p-1 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 text-green-500" title="Activar/Desactivar tasa automática">
                         <i class="fas fa-sync-alt"></i>
                     </button>
                </div>
                <div class="text-right">
                    <input type="number" id="exchange_rate" inputmode="decimal" class="w-24 text-right border rounded-md px-2 py-1 bg-gray-200 dark:bg-gray-600 dark:border-gray-500 transition-colors" readonly value="0.00">
                    <span id="rate-last-update" class="text-xs text-text-secondary block">Cargando...</span>
                    <span id="bcv-rate-display" class="text-xs text-blue-500 block font-semibold hidden"></span>
                </div>
            </div>
            <div class="text-lg font-bold flex justify-between"><span>Total USD:</span><span id="cart-total-usd">$0.00</span></div>
            <div class="text-lg font-bold flex justify-between mb-4"><span>Total Bs:</span><span id="cart-total-bs">Bs 0.00</span></div>
            <div class="grid grid-cols-2 gap-2">
                <button id="btn-finalize" class="btn btn-primary w-full">Finalizar & Ticket</button>
                <button id="btn-wa" class="btn btn-primary bg-green-500 hover:bg-green-600 w-full">WhatsApp</button>
                <button id="btn-summary" class="btn btn-secondary">Resumen del día</button>
                <button id="btn-analyze-sales" class="btn btn-secondary">✨ Analizar Ventas</button>
            </div>
        </div>
    </aside>

    <div id="modal-container" class="hidden">
        <div id="auth-modal" class="modal-content hidden">
            <form id="login-form" class="p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h3 class="text-2xl font-bold mb-4">Iniciar Sesión</h3>
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-text-secondary">Email</label>
                    <input type="email" id="email" required class="modal-input">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-text-secondary">Contraseña</label>
                    <input type="password" id="password" required class="modal-input">
                </div>
                <button type="submit" class="w-full btn btn-primary">Entrar</button>
                <button type="button" id="logout-button" class="w-full btn btn-danger mt-2 hidden">Cerrar Sesión</button>
            </form>
        </div>

        <div id="product-management-modal" class="modal-content hidden">
             <div class="p-6 rounded-lg shadow-xl w-full max-w-3xl h-[90vh] flex flex-col">
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="text-2xl font-bold">Gestionar Catálogo</h3>
                     <div class="flex flex-wrap gap-2">
                         <input type="file" id="json-upload-input" class="hidden" accept=".json,application/json">
                         <button id="export-json-btn" class="btn btn-secondary">Exportar JSON</button>
                         <button id="upload-json-btn" class="btn btn-secondary">Cargar JSON</button>
                         <button id="add-new-product-btn" class="btn btn-primary">Crear Producto</button>
                     </div>
                 </div>
                 
                 <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-btn-products" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Productos</button>
                        <button id="tab-btn-categories" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Categorías</button>
                    </nav>
                </div>

                 <div class="flex-grow overflow-y-auto pt-4">
                    <!-- Buscador para filtrar productos dentro de la gestión. Ayuda a encontrar rápido sin hacer scroll -->
                    <input type="text" id="product-manage-search" placeholder="Buscar producto" class="w-full p-2 mb-3 border border-border-color rounded-md text-sm" />
                    <div id="product-list-container">
                        <!-- Product list will be rendered here -->
                    </div>
                    <div id="category-list-container" class="hidden">
                        <!-- Category list will be rendered here -->
                    </div>
                 </div>
                 <div class="mt-4 text-right"><button type="button" class="btn-close-modal btn btn-secondary">Cerrar</button></div>
             </div>
        </div>

        <div id="product-form-modal" class="modal-content hidden">
             <form id="product-form" class="p-6 rounded-lg shadow-xl w-full max-w-lg h-[90vh] flex flex-col">
                 <h3 id="product-form-title" class="text-2xl font-bold mb-4"></h3>
                 <input type="hidden" id="product-id">
                 <div class="flex-grow overflow-y-auto pr-2 space-y-4">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div><label for="product-name" class="block text-sm font-medium">Nombre</label><input type="text" id="product-name" required class="modal-input"></div>
                         <div><label for="product-category" class="block text-sm font-medium">Categoría</label><input type="text" id="product-category" class="modal-input" list="category-list"></div>
                         <div><label for="product-price" class="block text-sm font-medium">Precio (USD)</label><input type="number" id="product-price" inputmode="decimal" required min="0" step="0.01" class="modal-input"></div>
                         <div><label for="product-stock" class="block text-sm font-medium">Stock</label><input type="number" id="product-stock" inputmode="decimal" required min="0" step="1" class="modal-input"></div>
                         <div><label for="product-ideal_stock" class="block text-sm font-medium">Stock Ideal</label><input type="number" id="product-ideal_stock" inputmode="decimal" min="0" step="1" class="modal-input"></div>
                         <div><label for="product-unit" class="block text-sm font-medium">Unidad</label><input type="text" id="product-unit" value="Unidad" class="modal-input"></div>
                         <div class="md:col-span-2"><label for="product-image" class="block text-sm font-medium">URL de Imagen</label><input type="url" id="product-image" class="modal-input"></div>
                     </div>
                     <div class="md:col-span-2"><label for="product-description" class="block text-sm font-medium">Descripción</label><div class="relative"><textarea id="product-description" rows="3" class="modal-input"></textarea><button type="button" id="generate-description-btn" class="absolute top-1 right-1 btn btn-secondary text-xs py-1 px-2">✨ Generar</button></div></div>
                     <div class="grid grid-cols-2 gap-4"><label class="flex items-center space-x-2"><input type="checkbox" id="product-is_service" class="rounded"><span>Es servicio</span></label><label class="flex items-center space-x-2"><input type="checkbox" id="product-sold_by_weight" class="rounded"><span>Vendido por peso</span></label><label class="flex items-center space-x-2"><input type="checkbox" id="product-sold_by_length" class="rounded"><span>Vendido por metro</span></label><label class="flex items-center space-x-2"><input type="checkbox" id="product-allow_manual_price" class="rounded"><span>Precio manual</span></label></div>
                 </div>
                 <div class="mt-6 flex justify-between items-center">
                     <button type="button" id="delete-product-btn" class="btn btn-danger">Eliminar</button>
                     <div><button type="button" class="btn-close-modal btn btn-secondary mr-2">Cancelar</button><button type="submit" class="btn btn-primary">Guardar</button></div>
                 </div>
             </form>
        </div>
        
        <div id="quantity-modal" class="modal-content hidden">
             <div class="p-6 rounded-lg shadow-xl w-full max-w-xs">
                 <h3 id="quantity-modal-title" class="text-xl font-bold mb-4"></h3>
                 <input type="hidden" id="quantity-product-id">
                 <div class="mb-4"><label id="quantity-label" for="quantity-input" class="block text-sm font-medium"></label><input type="number" id="quantity-input" inputmode="decimal" min="0" step="0.01" required class="modal-input text-lg text-center p-2"></div>
                 <div id="price-input-container" class="mb-4 hidden"><label for="manual-price-input" class="block text-sm font-medium">Precio Manual (USD)</label><input type="number" id="manual-price-input" inputmode="decimal" min="0" step="0.01" class="modal-input text-lg text-center p-2"></div>
                 <div class="flex justify-end space-x-2"><button type="button" class="btn-close-modal btn btn-secondary">Cancelar</button><button id="quantity-modal-confirm" class="btn btn-primary">Aceptar</button></div>
             </div>
        </div>

        <div id="payment-modal" class="modal-content hidden">
            <div class="p-6 rounded-lg shadow-xl w-full max-w-md">
                <h3 class="text-2xl font-bold mb-4">Registrar Pago</h3>
                <div class="mb-4 p-4 rounded-lg bg-indigo-50 dark:bg-gray-800 text-center">
                    <p class="text-sm text-indigo-800 dark:text-indigo-300">Total a Pagar</p>
                    <p id="payment-total-display" class="text-3xl font-bold text-indigo-900 dark:text-indigo-100">$0.00</p>
                </div>
                <div id="payment-methods-container" class="space-y-3"></div>
                <div class="mt-4 p-2 rounded-lg text-center" id="payment-balance-container">
                    <p class="text-sm">Restante</p>
                    <p id="payment-remaining" class="text-xl font-bold text-red-600">$0.00</p>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <div>
                        <button type="button" class="btn-close-modal btn btn-secondary">Cancelar</button>
                        <button id="confirm-payment-btn" class="btn btn-primary ml-2" disabled>Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="gemini-modal" class="modal-content hidden">
             <div class="p-6 rounded-lg shadow-xl w-full max-w-lg h-[70vh] flex flex-col">
                 <div class="flex justify-between items-center mb-4"><h3 id="gemini-modal-title" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-indigo-600">✨ Asistente de IA</h3><button type="button" class="btn-close-modal p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-times"></i></button></div>
                 <div id="gemini-modal-content" class="flex-grow overflow-y-auto bg-primary p-4 rounded-lg prose dark:prose-invert"></div>
                 <div id="gemini-modal-footer" class="mt-4 text-right"><button type="button" class="btn-close-modal btn btn-secondary">Cerrar</button></div>
             </div>
        </div>

        <!-- Modal para crear vendedores. Visible sólo para administradores. -->
        <div id="create-seller-modal" class="modal-content hidden">
             <form id="create-seller-form" class="p-6 rounded-lg shadow-xl w-full max-w-sm">
                 <h3 class="text-2xl font-bold mb-4">Crear Vendedor</h3>
                 <div class="mb-4">
                     <label for="seller-email" class="block text-sm font-medium text-text-secondary">Email</label>
                     <input type="email" id="seller-email" required class="modal-input">
                 </div>
                 <div class="mb-6">
                     <label for="seller-password" class="block text-sm font-medium text-text-secondary">Contraseña</label>
                     <input type="password" id="seller-password" required class="modal-input">
                 </div>
                 <button type="submit" class="w-full btn btn-primary">Crear</button>
                 <button type="button" class="w-full btn-close-modal btn btn-secondary mt-2">Cancelar</button>
             </form>
        </div>
        <!-- Modal to manage sellers (list, edit, delete) for administrators -->
        <div id="seller-management-modal" class="modal-content hidden">
             <div class="p-6 rounded-lg shadow-xl w-full max-w-md h-[90vh] flex flex-col">
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="text-2xl font-bold">Gestionar Vendedores</h3>
                 </div>
                 <!-- Search bar for filtering sellers by email -->
                 <input type="text" id="seller-search" placeholder="Buscar vendedor" class="w-full p-2 mb-3 border border-border-color rounded-md text-sm" />
                 <div id="seller-list-container" class="flex-grow overflow-y-auto space-y-2">
                     <!-- List of sellers will be rendered here -->
                 </div>
                 <div class="mt-4 text-right">
                     <button type="button" class="btn-close-modal btn btn-secondary">Cerrar</button>
                 </div>
             </div>
        </div>
    </div>
    
    <!--
        Toast notification container.  Add a high z-index (z-50) so that
        messages always appear above any modals or overlays.  Without this
        class the toast could be hidden behind the semi‑transparent modal
        backdrop, making feedback invisible when editing sellers or inputting
        incorrect passwords.
    -->
    <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 max-w-md text-center z-50">
         <p id="toast-message"></p>
    </div>

    <footer class="text-center py-6 text-sm text-text-secondary">
        <p>&copy; 2025 EmprendeVenta POS | Tu Negocio, al Día y Creciendo</p>
    </footer>

    <script type="module">
        const SUPABASE_URL = 'https://dcpvasczyhfjthdxctax.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjcHZhc2N6eWhmanRoZHhjdGF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNjA3NzgsImV4cCI6MjA3MjgzNjc3OH0.0cEoNxe4_Sw3BsSyV1E3FuoIpdmQoP1RJoIybAEh3kI';
        
        window.products = [
            { id: 'PROD001', name: 'Café Americano', category: 'Bebidas', price: 2.5, stock: 10, ideal_stock: 20, unit: 'Taza', is_service: true, sold_by_weight: false, sold_by_length: false, allow_manual_price: false, image: '', description: 'Café negro, fuerte y aromático.' },
            { id: 'PROD002', name: 'Croissant', category: 'Panadería', price: 1.8, stock: 50, ideal_stock: 30, unit: 'Unidad', is_service: false, sold_by_weight: false, sold_by_length: false, allow_manual_price: false, image: '', description: 'Clásico hojaldre francés.' },
            { id: 'PROD003', name: 'Jugo de Naranja', category: 'Bebidas', price: 3.0, stock: 80, ideal_stock: 25, unit: 'Vaso', is_service: true, sold_by_weight: false, sold_by_length: false, allow_manual_price: false, image: '', description: 'Jugo 100% natural.' },
            { id: 'PROD004', name: 'Queso por Kilo', category: 'Lácteos', price: 15.0, stock: 5, ideal_stock: 10, unit: 'kg', is_service: false, sold_by_weight: true, sold_by_length: false, allow_manual_price: false, image: '', description: 'Queso blanco semiduro.' },
            { id: 'PROD005', name: 'Tela por Metro', category: 'Mercería', price: 8.5, stock: 100, ideal_stock: 50, unit: 'm', is_service: false, sold_by_weight: false, sold_by_length: true, allow_manual_price: false, image: '', description: 'Tela de algodón de alta calidad.' },
            { id: 'PROD006', name: 'Asesoría', category: 'Servicios', price: 50.0, stock: 999, ideal_stock: 999, unit: 'Hora', is_service: true, sold_by_weight: false, sold_by_length: false, allow_manual_price: true, image: '', description: 'Asesoría profesional por hora.' }
        ];

        const fullSqlScript = `
            -- Cleanup existing objects to avoid conflicts when re‑initialising the database.
            DROP FUNCTION IF EXISTS decrement_stock(text, numeric);
            DROP FUNCTION IF EXISTS is_admin_user(uuid) CASCADE;
            DROP FUNCTION IF EXISTS create_profile_for_new_user() CASCADE;
            DROP TABLE IF EXISTS venta_items;
            DROP TABLE IF EXISTS ventas CASCADE;
            DROP TABLE IF EXISTS productos CASCADE;
            DROP TABLE IF EXISTS profiles CASCADE;

            -- Core tables
            CREATE TABLE productos (
                id TEXT PRIMARY KEY,
                name TEXT NOT NULL,
                description TEXT,
                category TEXT,
                price NUMERIC DEFAULT 0,
                stock NUMERIC DEFAULT 0,
                ideal_stock NUMERIC DEFAULT 0,
                unit TEXT DEFAULT 'Unidad',
                is_service BOOLEAN DEFAULT FALSE,
                sold_by_weight BOOLEAN DEFAULT FALSE,
                sold_by_length BOOLEAN DEFAULT FALSE,
                allow_manual_price BOOLEAN DEFAULT FALSE,
                image TEXT,
                created_at TIMESTAMPTZ DEFAULT NOW()
            );

            CREATE TABLE ventas (
                id TEXT PRIMARY KEY,
                created_at TIMESTAMPTZ DEFAULT NOW(),
                total_usd NUMERIC NOT NULL,
                exchange_rate NUMERIC,
                items INTEGER,
                payment_methods JSONB,
                seller_id UUID REFERENCES auth.users(id) ON DELETE SET NULL
            );

            CREATE TABLE venta_items (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                venta_id TEXT REFERENCES ventas(id) ON DELETE CASCADE,
                producto_id TEXT REFERENCES productos(id) ON DELETE SET NULL,
                quantity NUMERIC NOT NULL,
                price NUMERIC NOT NULL
            );

            -- Profiles table stores the role for each authenticated user.  New
            -- users are given the "buyer" role by default and can be promoted
            -- to "seller" or "admin" by an administrator.
            CREATE TABLE profiles (
                id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
                role TEXT NOT NULL DEFAULT 'buyer'
            );

            -- Automatically insert a profile row when a new auth user is created.
            CREATE OR REPLACE FUNCTION public.create_profile_for_new_user()
            RETURNS TRIGGER AS $$
            BEGIN
                -- Insert the new user's profile with default role 'buyer'.  Use the
                -- fully‑qualified table name to avoid search_path issues.
                INSERT INTO public.profiles(id, role) VALUES (NEW.id, 'buyer');
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql SECURITY DEFINER;

            CREATE TRIGGER on_auth_user_created
            AFTER INSERT ON auth.users
            FOR EACH ROW EXECUTE FUNCTION public.create_profile_for_new_user();

            -- Helper function to test whether the supplied user id belongs to
            -- an administrator.  Used in row‑level security policies to
            -- restrict operations to admins.
            CREATE OR REPLACE FUNCTION is_admin_user(user_id UUID)
            RETURNS BOOLEAN
            LANGUAGE plpgsql
            SECURITY DEFINER
            AS $$
            DECLARE
                is_admin BOOLEAN;
            BEGIN
                SELECT role = 'admin' INTO is_admin FROM profiles WHERE id = user_id;
                RETURN COALESCE(is_admin, false);
            END;
            $$;

            -- Helper function to decrement stock for non‑service products when
            -- recording a sale.  This function is invoked from the client code
            -- after a successful sale.
            -- The decrement_stock function now runs with SECURITY DEFINER so
            -- that it can update the productos table on behalf of sellers.
            -- Without SECURITY DEFINER, row‑level security would prevent
            -- sellers from decrementing stock (only admins could update).
            CREATE OR REPLACE FUNCTION decrement_stock(product_id TEXT, decrement_value NUMERIC)
            RETURNS void
            LANGUAGE plpgsql
            SECURITY DEFINER AS $$
            BEGIN
                UPDATE productos
                SET stock = stock - decrement_value
                WHERE id = product_id AND is_service = FALSE;
            END;
            $$;

            -- Enable row level security (RLS) on all tables.  Without RLS
            -- policies, no authenticated user can access table rows.
            ALTER TABLE productos ENABLE ROW LEVEL SECURITY;
            ALTER TABLE ventas    ENABLE ROW LEVEL SECURITY;
            ALTER TABLE venta_items ENABLE ROW LEVEL SECURITY;
            ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

            -- Products: everyone can read; only administrators can insert,
            -- update or delete products.  Sellers and buyers may never
            -- modify the catalogue.
            CREATE POLICY "Productos public read" ON productos
              FOR SELECT USING (true);
            CREATE POLICY "Productos admin manage" ON productos
              FOR ALL USING (is_admin_user(auth.uid()))
              WITH CHECK (is_admin_user(auth.uid()));

            -- Profiles: each user can view their own profile row.  Only
            -- administrators can edit or view other users' profiles.
            CREATE POLICY "Profiles: user can view own" ON profiles
              FOR SELECT TO authenticated
              USING (id = auth.uid());
            CREATE POLICY "Profiles: admin manage" ON profiles
              FOR ALL TO authenticated
              USING (is_admin_user(auth.uid()))
              WITH CHECK (is_admin_user(auth.uid()));

            -- Allow the trigger function to insert a profile row when a new
            -- user registers.  Without this explicit insert policy, row
            -- level security would prevent the insert from happening.
            CREATE POLICY "Profiles: allow insert" ON profiles
              FOR INSERT
              WITH CHECK (true);

            -- Sales (ventas): sellers and administrators can insert and read
            -- sales; only administrators can update or delete existing sales.
            CREATE POLICY "Ventas: sellers insert" ON ventas
              FOR INSERT TO authenticated
              WITH CHECK (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('seller','admin')));
            CREATE POLICY "Ventas: sellers view" ON ventas
              FOR SELECT TO authenticated
              USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('seller','admin')));
            CREATE POLICY "Ventas: admin manage" ON ventas
              FOR ALL TO authenticated
              USING (is_admin_user(auth.uid()))
              WITH CHECK (is_admin_user(auth.uid()));

            -- Sale items: sellers and administrators can insert, view and
            -- update sale items; only administrators can delete them.
            CREATE POLICY "Venta items: sellers insert" ON venta_items
              FOR INSERT TO authenticated
              WITH CHECK (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('seller','admin')));
            CREATE POLICY "Venta items: sellers view" ON venta_items
              FOR SELECT TO authenticated
              USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('seller','admin')));
            CREATE POLICY "Venta items: sellers update" ON venta_items
              FOR UPDATE TO authenticated
              USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('seller','admin')))
              WITH CHECK (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('seller','admin')));
            CREATE POLICY "Venta items: admin delete" ON venta_items
              FOR DELETE TO authenticated
              USING (is_admin_user(auth.uid()));

            -- Include productos table in the realtime publication so that
            -- product changes are broadcast to clients via websockets.
            ALTER PUBLICATION supabase_realtime ADD TABLE productos;
        `;
        
        const { createClient } = supabase;
        window.supabaseClient = null;
        let allProducts = [], session = null, currentModal = null;
        // Persist the logged in user's email separately from the session
        // because the offline fallback session only stores the user id.  We
        // populate this field when a session is obtained from Supabase and
        // restore it from localStorage when offline.
        let userEmail = null;
        let appLoaded = false;
        window.cart = [];
        let deferredInstallPrompt = null;
        let isBcvAuto = true;
        let latestBcvRate = 0;

        // Role of currently signed in user.  Possible values: 'admin', 'seller', 'buyer'.
        let userRole = null;

        /**
         * Fetch the role of the current user from the `profiles` table.
         * On error or if not authenticated, userRole will be null.
         */
        async function fetchUserRole() {
            if (!session || !supabaseClient) {
                userRole = null;
                return;
            }
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('role')
                    .eq('id', session.user.id)
                    .single();
                if (error) {
                    console.error('Error fetching user role:', error);
                    userRole = null;
                } else {
                    userRole = data?.role || null;
                    // Persist the user's role and id for offline use
                    if (userRole) {
                        try {
                            localStorage.setItem('userRole', userRole);
                            if (session && session.user && session.user.id) {
                                localStorage.setItem('userId', session.user.id);
                            }
                        } catch(err) {
                            console.warn('Could not persist user role', err);
                        }
                    }
                }
            } catch (err) {
                console.error('Error fetching user role:', err);
                userRole = null;
            }
        }

        /**
         * Update UI controls that depend on the user's role.
         * Admins can see and use management and analysis buttons.
         */
        function updateUIByRole() {
            // Determine role flags.  Administrators inherit seller permissions.
            const isAdmin  = userRole === 'admin';
            const isSeller = userRole === 'seller' || isAdmin;
            // Consider unauthenticated visitors as buyers so they can view the catalog
            const isBuyer  = !session || userRole === 'buyer';

            // Gestión del catálogo sólo para administradores
            const manageBtn = document.getElementById('btn-manage-products');
            if (manageBtn) {
                manageBtn.classList.toggle('hidden', !isAdmin);
                manageBtn.disabled = !session || !isAdmin;
            }

            // Botón para crear vendedores (sólo visible y habilitado para administradores)
            const createSellerBtn = document.getElementById('btn-create-seller');
            if (createSellerBtn) {
                createSellerBtn.classList.toggle('hidden', !isAdmin);
                createSellerBtn.disabled = !session || !isAdmin;
            }

            // Botón para gestionar vendedores (listar/editar/eliminar) solo para administradores
            const manageSellersBtn = document.getElementById('btn-manage-sellers');
            if (manageSellersBtn) {
                manageSellersBtn.classList.toggle('hidden', !isAdmin);
                manageSellersBtn.disabled = !session || !isAdmin;
            }

            // Análisis de ventas sólo para administradores
            const analyzeBtn = document.getElementById('btn-analyze-sales');
            if (analyzeBtn) {
                analyzeBtn.classList.toggle('hidden', !isAdmin);
                analyzeBtn.disabled = !session || !isAdmin;
            }

            // Opciones de venta (finalizar venta y WhatsApp) accesibles para vendedores y administradores.
            ['btn-finalize', 'btn-wa'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.toggle('hidden', !isSeller || !session);
                    el.disabled = !session || !isSeller;
                }
            });
            // El resumen del día sólo lo ve el administrador
            const summaryBtn = document.getElementById('btn-summary');
            if (summaryBtn) {
                summaryBtn.classList.toggle('hidden', !isAdmin || !session);
                summaryBtn.disabled = !session || !isAdmin;
            }
        }

        Object.defineProperty(window, 'exchangeRate', { get: () => parseFloat(document.getElementById('exchange_rate').value) || 0 });

        const DOM = {
            themeToggleBtn: document.getElementById('theme-toggle-btn'), productGrid: document.getElementById('product-grid'),
            viewToggleBtn: document.getElementById('view-toggle-btn'), modalContainer: document.getElementById('modal-container'),
            cartDrawer: document.getElementById('cart-drawer'), cartItemsContainer: document.getElementById('cart-items'),
            cartTotalUsdEl: document.getElementById('cart-total-usd'), cartTotalBsEl: document.getElementById('cart-total-bs'),
            cartItemCountEl: document.getElementById('cart-item-count'), searchInput: document.getElementById('search-input'),
            authButton: document.getElementById('auth-button'), authIcon: document.getElementById('auth-icon'),
            installAppBtn: document.getElementById('install-app-btn'),
            bcvToggleBtn: document.getElementById('bcv-toggle-btn'),
            exchangeRateInput: document.getElementById('exchange_rate'),
        };

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.querySelector('#toast-message').textContent = message;
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, duration);
        }

        function formatCurrency(amount, currency = 'USD') {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency === 'USD' ? 'USD' : 'VES' }).format(amount).replace('VES', 'Bs');
        }
        
        function slugify(text) {
             if (typeof text !== 'string') return '';
             const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
             const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
             const p = new RegExp(a.split('').join('|'), 'g')
             return text.toString().toLowerCase().replace(/\s+/g, '-').replace(p, c => b.charAt(a.indexOf(c))).replace(/&/g, '-and-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '')
        }

        function normalizeText(text = '') {
            return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        const Theme = {
            sunIcon: '<i class="fas fa-sun text-gray-600 dark:text-gray-300"></i>',
            moonIcon: '<i class="fas fa-moon text-gray-600 dark:text-gray-300"></i>',
            apply(theme) {
                document.documentElement.classList.toggle('dark', theme === 'dark');
                DOM.themeToggleBtn.innerHTML = theme === 'dark' ? this.sunIcon : this.moonIcon;
            },
            toggle() {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                this.apply(newTheme);
            }
        };

        function openModal(modalId) {
            const modalContent = document.getElementById(modalId);
            if (!modalContent) return;
            DOM.modalContainer.querySelectorAll('.modal-content').forEach(mc => mc.classList.add('hidden'));
            modalContent.classList.remove('hidden');
            DOM.modalContainer.className = 'modal-overlay-bg fixed inset-0 flex items-center justify-center z-30';
            currentModal = modalId;
        }

        function closeModal() {
            if (!currentModal) return;
            const modalContent = document.getElementById(currentModal);
            if (modalContent) modalContent.classList.add('hidden');
            DOM.modalContainer.classList.add('hidden');
            currentModal = null;
        }
        
        function showConfirmation(message) {
             return new Promise(resolve => {
                 const wrap = document.createElement('div');
                 wrap.className = 'modal-overlay-bg fixed inset-0 flex items-center justify-center z-50';
                 wrap.innerHTML = `<div class="bg-secondary p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
                     <h3 class="text-xl font-bold mb-3">Confirmación</h3>
                     <p class="mb-6">${message}</p>
                     <div class="flex justify-center space-x-4">
                         <button id="confirm-cancel-btn" class="btn btn-secondary w-28">Cancelar</button>
                         <button id="confirm-ok-btn" class="btn btn-primary w-28">Aceptar</button>
                     </div>
                 </div>`;
                 document.body.appendChild(wrap);
                 const close = (value) => { wrap.remove(); resolve(value); };
                 wrap.querySelector('#confirm-ok-btn').onclick = () => close(true);
                 wrap.querySelector('#confirm-cancel-btn').onclick = () => close(false);
             });
        }

        function renderProducts(productsToRender = allProducts) {
            DOM.productGrid.innerHTML = '';
            document.getElementById('no-products-msg').classList.toggle('hidden', productsToRender.length > 0);
            productsToRender.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card bg-secondary rounded-lg shadow-md p-3 flex flex-col cursor-pointer transition-all duration-200 hover:shadow-xl dark:border dark:border-border-color';
                card.dataset.productId = p.id;
                
                let stockInfo;
                if (p.is_service) {
                    stockInfo = '<span class="text-indigo-500">Servicio</span>';
                } else if (p.stock <= 0) {
                    stockInfo = '<span class="font-bold text-red-500">No disponible</span>';
                } else {
                    const stockColor = p.stock > 10 ? 'text-green-500' : 'text-yellow-500';
                    stockInfo = `<span class="${stockColor}">${p.stock} ${p.unit}</span>`;
                }

                const isLowStock = !p.is_service && p.stock > 0 && p.stock <= (p.ideal_stock || 0) && (p.ideal_stock || 0) > 0;
                
                const badgeHTML = p.stock <= 0 && !p.is_service ? '<div class="absolute top-1 right-1 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full">No Disponible</div>'
                                  : isLowStock ? '<div class="absolute top-1 right-1 bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">Poco Stock</div>' : '';

                const priceBs = (p.price * window.exchangeRate).toFixed(2);
                card.innerHTML = `
                    <div class="product-image-container relative flex-shrink-0">
                        <img src="${p.image || 'https://placehold.co/300x200/e2e8f0/adb5bd?text=P'}" alt="${p.name}" class="w-full h-24 md:h-32 object-cover rounded-md mb-2">
                        ${badgeHTML}
                    </div>
                    <div class="product-info-container flex flex-col flex-grow">
                        <div class="flex-grow">
                            <h4 class="font-bold text-sm">${p.name}</h4>
                            <p class="text-xs text-text-secondary">${p.category || ''}</p>
                        </div>
                        <div class="mt-2 text-xs">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-base" style="color: var(--primary-color);">${formatCurrency(p.price)}</span>
                                ${stockInfo}
                            </div>
                            <div class="text-right text-text-secondary">Bs ${priceBs}</div>
                        </div>
                    </div>`;
                card.addEventListener('click', () => handleProductClick(p.id));
                DOM.productGrid.appendChild(card);
            });
        }
        
        function renderCategoryFilters() {
            const categories = ['Todos', ...new Set(allProducts.map(p => p.category).filter(Boolean))];
            const container = document.getElementById('category-filters');
            container.innerHTML = '';
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn flex-shrink-0';
                if (category === 'Todos') btn.classList.add('active');
                btn.textContent = category;
                btn.dataset.category = category;
                btn.addEventListener('click', handleFilterClick);
                container.appendChild(btn);
            });

            const lowStockBtn = document.createElement('button');
            lowStockBtn.className = 'category-btn flex-shrink-0 text-yellow-400 border-yellow-400 dark:text-yellow-400 dark:border-yellow-500';
            lowStockBtn.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>Bajo Stock`;
            lowStockBtn.dataset.filter = 'low-stock';
            lowStockBtn.addEventListener('click', handleFilterClick);
            container.appendChild(lowStockBtn);
        }
        
        function renderCart() {
            DOM.cartItemsContainer.innerHTML = ''; let totalUsd = 0;
            if (window.cart.length === 0) {
                DOM.cartItemsContainer.innerHTML = `<p class="text-center text-text-secondary mt-8">El carrito está vacío.</p>`;
            } else {
                window.cart.forEach(item => {
                    const subtotal = item.price * item.quantity; totalUsd += subtotal;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between py-3 border-b border-border-color';
                    itemEl.innerHTML = `
                        <div class="w-2/3 flex items-center">
                            <div>
                                <p class="font-semibold text-sm">${item.name}</p>
                                <p class="text-xs text-text-secondary">${formatCurrency(item.price)}</p>
                            </div>
                        </div>
                        <div class="w-1/3 flex flex-col items-end">
                            <p class="font-bold mb-1">${formatCurrency(subtotal)}</p>
                            <div class="flex items-center gap-2">
                                <button data-id="${item.id}" data-price="${item.price}" class="decrease-qty-btn btn btn-secondary p-0 w-6 h-6">-</button>
                                <span class="font-semibold w-8 text-center">${item.quantity}</span>
                                <button data-id="${item.id}" data-price="${item.price}" class="increase-qty-btn btn btn-secondary p-0 w-6 h-6">+</button>
                                <button data-id="${item.id}" data-price="${item.price}" class="remove-item-btn text-red-500 hover:text-red-700 ml-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                    DOM.cartItemsContainer.appendChild(itemEl);
                });
            }
            DOM.cartTotalUsdEl.textContent = formatCurrency(totalUsd); DOM.cartTotalBsEl.textContent = formatCurrency(totalUsd * window.exchangeRate, 'BS');
            DOM.cartItemCountEl.textContent = window.cart.length;

            const setupCartButtonListeners = (selector, change) => {
                DOM.cartItemsContainer.querySelectorAll(selector).forEach(btn => btn.addEventListener('click', e => {
                    const { id, price } = e.currentTarget.dataset;
                    updateCartQuantity(id, price, change);
                }));
            };
            
            setupCartButtonListeners('.increase-qty-btn', 1);
            setupCartButtonListeners('.decrease-qty-btn', -1);

            DOM.cartItemsContainer.querySelectorAll('.remove-item-btn').forEach(btn => btn.addEventListener('click', e => {
                const { id, price } = e.currentTarget.dataset;
                window.cart = window.cart.filter(item => !(item.id === id && item.price == price)); 
                renderCart();
            }));
        }

        function updateCartQuantity(productId, price, change) {
            const itemIndex = window.cart.findIndex(item => item.id === productId && item.price == price);
            if (itemIndex > -1) {
                const item = window.cart[itemIndex];
                const product = allProducts.find(p => p.id === productId);
                const newQuantity = item.quantity + change;

                if (change > 0 && !item.is_service && newQuantity > product.stock) {
                    showToast(`Stock máximo alcanzado para ${item.name}. Disponible: ${product.stock}`, 4000);
                    return;
                }

                if (newQuantity <= 0) {
                    window.cart.splice(itemIndex, 1);
                } else {
                    const isDecimal = item.sold_by_weight || item.sold_by_length;
                    item.quantity = isDecimal ? parseFloat(newQuantity.toFixed(2)) : newQuantity;
                }
                renderCart();
            }
        }

        function filterProducts() {
            const query = normalizeText(DOM.searchInput.value);
            const activeFilterBtn = document.querySelector('#category-filters .category-btn.active');
            
            let productsToRender = allProducts;

            if (activeFilterBtn) {
                const filterType = activeFilterBtn.dataset.filter;
                const category = activeFilterBtn.dataset.category;

                if (filterType === 'low-stock') {
                    productsToRender = allProducts.filter(p => !p.is_service && p.stock <= (p.ideal_stock || 0) && (p.ideal_stock || 0) > 0);
                } else if (category && category !== 'Todos') {
                    productsToRender = allProducts.filter(p => p.category === category);
                }
            }

            if (query) {
                productsToRender = productsToRender.filter(p => normalizeText(p.name).includes(query) || normalizeText(p.category).includes(query));
            }
            
            renderProducts(productsToRender);
        }

        function handleFilterClick(e) {
            document.querySelectorAll('#category-filters .category-btn').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            filterProducts();
        }

        function handleProductClick(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            if (!product.is_service && product.stock <= 0) {
                showToast(`${product.name} no está disponible.`, 3000);
                return;
            }

            const currentQtyInCart = window.cart.filter(item => item.id === productId).reduce((acc, item) => acc + item.quantity, 0);

            if (!product.is_service && currentQtyInCart >= product.stock) {
                showToast(`No hay más stock para ${product.name}.`, 4000);
                return;
            }

            if (product.sold_by_weight || product.sold_by_length || product.allow_manual_price) {
                openQuantityModal(product);
            } else {
                addToCart(product, 1, product.price);
            }
        }

        function addToCart(product, quantity, price) {
            const existingItem = window.cart.find(item => item.id === product.id && item.price === price);
            const currentQtyInCart = existingItem ? existingItem.quantity : 0;
            
            if (!product.is_service && (currentQtyInCart + quantity) > product.stock) {
                showToast(`Stock insuficiente para ${product.name}. Disponible: ${product.stock}`, 4000);
                return;
            }

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                window.cart.push({ ...product, quantity, price });
            }
            showToast(`${product.name} agregado al carrito.`); renderCart();
        }

        async function fetchAndUpdateExchangeRate() {
            const lastUpdateEl = document.getElementById('rate-last-update');
            const bcvDisplayEl = document.getElementById('bcv-rate-display');
            try {
                const response = await fetch('https://ve.dolarapi.com/v1/dolares/oficial', { cache: 'no-cache' });
                if (!response.ok) throw new Error('Network response error');
                const data = await response.json();
                const bcvRate = data?.promedio || data?.venta;
                if (bcvRate) {
                    latestBcvRate = bcvRate;
                    bcvDisplayEl.textContent = `BCV: ${latestBcvRate.toFixed(2)}`;
                    bcvDisplayEl.classList.remove('hidden');
                    if (isBcvAuto) {
                        DOM.exchangeRateInput.value = latestBcvRate.toFixed(2);
                        lastUpdateEl.textContent = `Actualizado: ${new Date().toLocaleTimeString('es-VE')}`;
                    }
                    renderCart();
                    filterProducts();
                } else {
                    lastUpdateEl.textContent = 'No se pudo actualizar';
                }
            } catch (error) {
                console.error('Error fetching exchange rate:', error);
                lastUpdateEl.textContent = 'Error al actualizar';
                bcvDisplayEl.textContent = 'BCV: -';
                bcvDisplayEl.classList.remove('hidden');
            }
        }
        
        function clearCartAndNotify(message = 'Venta registrada con éxito.') { window.cart = []; renderCart(); showToast(message); }

        const paymentMethodsConfig = [ { id: 'efectivo_usd', label: 'Efectivo USD', icon: 'fa-money-bill-wave' }, { id: 'efectivo_bs', label: 'Efectivo Bs', icon: 'fa-money-bill-wave' }, { id: 'zelle', label: 'Zelle', icon: 'fa-bolt' }, { id: 'tarjeta', label: 'Tarjeta', icon: 'fa-credit-card' }, { id: 'pago_movil', label: 'Pago Móvil', icon: 'fa-mobile-alt' }, ];
        function openPaymentModal() {
            const totalUSD = window.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('payment-total-display').textContent = formatCurrency(totalUSD);
            const container = document.getElementById('payment-methods-container');
            container.innerHTML = '';
            paymentMethodsConfig.forEach(method => {
                const el = document.createElement('div');
                el.className = 'flex items-center gap-3';
                el.innerHTML = `<label for="payment-${method.id}" class="w-1/3 flex items-center gap-2 text-sm text-text-primary"><i class="fas ${method.icon} text-text-secondary"></i> ${method.label}</label><input type="number" id="payment-${method.id}" data-method="${method.id}" class="payment-input modal-input flex-grow p-2" placeholder="0.00">`;
                container.appendChild(el);
            });
            container.querySelectorAll('.payment-input').forEach(input => input.addEventListener('input', updatePaymentBalance));
            updatePaymentBalance(); openModal('payment-modal');
        }

        function updatePaymentBalance() {
            const totalUSD = window.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let paidAmount = 0; document.querySelectorAll('.payment-input').forEach(input => { paidAmount += parseFloat(input.value) || 0; });
            const remaining = totalUSD - paidAmount; const remainingEl = document.getElementById('payment-remaining'); const confirmBtn = document.getElementById('confirm-payment-btn');
            if (Math.abs(remaining) < 0.001) { remainingEl.className = 'text-xl font-bold text-green-500'; remainingEl.textContent = '¡Pagado!'; confirmBtn.disabled = false; }
            else if (remaining < 0) { remainingEl.className = 'text-xl font-bold text-yellow-500'; remainingEl.textContent = `Cambio: ${formatCurrency(Math.abs(remaining))}`; confirmBtn.disabled = false; }
            else { remainingEl.className = 'text-xl font-bold text-red-500'; remainingEl.textContent = `Restante: ${formatCurrency(remaining)}`; confirmBtn.disabled = true; }
        }

        function openQuantityModal(product) {
            document.getElementById('quantity-product-id').value = product.id;
            const titleEl = document.getElementById('quantity-modal-title');
            const labelEl = document.getElementById('quantity-label');
            const inputEl = document.getElementById('quantity-input');
            const priceContainer = document.getElementById('price-input-container');
            const priceInputEl = document.getElementById('manual-price-input');
            titleEl.textContent = product.name; inputEl.value = '1';
            if (product.sold_by_weight) { labelEl.textContent = 'Cantidad (kg)'; inputEl.step = '0.01'; }
            else if (product.sold_by_length) { labelEl.textContent = 'Longitud (m)'; inputEl.step = '0.01'; }
            else { labelEl.textContent = 'Cantidad'; inputEl.step = '1'; }
            priceContainer.classList.toggle('hidden', !product.allow_manual_price);
            if(product.allow_manual_price) priceInputEl.value = product.price;
            openModal('quantity-modal');
        }

        function renderProductManagementList() {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '';
            if (allProducts.length === 0) {
                container.innerHTML = `<p class="text-text-secondary text-center p-4">No hay productos.</p>`;
                return;
            }
            // Filtra por el texto de búsqueda en el gestor
            const searchEl = document.getElementById('product-manage-search');
            const query = searchEl ? searchEl.value.trim().toLowerCase() : '';
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(query));
            filtered.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 border-b border-border-color last:border-b-0 hover:bg-accent';
                item.innerHTML = `<div><p class="font-semibold">${p.name}</p><p class="text-sm text-text-secondary">${formatCurrency(p.price)} - Stock: ${p.stock}</p></div><button data-id="${p.id}" class="edit-product-btn btn btn-secondary text-sm">Editar</button>`;
                container.appendChild(item);
            });
            document.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', (e) => openProductForm(e.target.dataset.id)));
        }

        function renderCategoryManagementList() {
            const container = document.getElementById('category-list-container');
            container.innerHTML = '';
            const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))].sort();
            if (categories.length === 0) {
                 container.innerHTML = `<p class="text-text-secondary text-center p-4">No hay categorías.</p>`;
                 return;
            }
            container.innerHTML = categories.map(cat => `
                <div class="flex justify-between items-center p-2 border-b border-border-color last:border-b-0 hover:bg-accent">
                    <span>${cat}</span>
                    <button data-category="${cat}" class="delete-category-btn btn btn-danger text-xs py-1 px-2">Eliminar</button>
                </div>
            `).join('');
            document.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteCategory(e.target.dataset.category)));
        }
        
        function switchManagementTab(tabToShow) {
            const productsTabBtn = document.getElementById('tab-btn-products');
            const categoriesTabBtn = document.getElementById('tab-btn-categories');
            const productsContent = document.getElementById('product-list-container');
            const categoriesContent = document.getElementById('category-list-container');
            
            const activeClasses = 'border-indigo-500 text-indigo-600 dark:border-indigo-400 dark:text-indigo-400'.split(' ');
            const inactiveClasses = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600'.split(' ');

            if (tabToShow === 'products') {
                productsContent.classList.remove('hidden');
                categoriesContent.classList.add('hidden');
                
                productsTabBtn.classList.add(...activeClasses);
                productsTabBtn.classList.remove(...inactiveClasses);
                
                categoriesTabBtn.classList.add(...inactiveClasses);
                categoriesTabBtn.classList.remove(...activeClasses);

            } else { // 'categories'
                productsContent.classList.add('hidden');
                categoriesContent.classList.remove('hidden');
                
                categoriesTabBtn.classList.add(...activeClasses);
                categoriesTabBtn.classList.remove(...inactiveClasses);
                
                productsTabBtn.classList.add(...inactiveClasses);
                productsTabBtn.classList.remove(...activeClasses);
            }
        }

        async function handleDeleteCategory(category) {
            if (!await showConfirmation(`¿Seguro que quieres eliminar la categoría "${category}"? Esto eliminará TODOS los productos dentro de ella de forma permanente.`)) return;
            
            const productsToDelete = allProducts.filter(p => p.category === category);
            if (productsToDelete.length === 0) {
                showToast(`No se encontraron productos para eliminar en "${category}".`);
                return;
            }
            const productIdsToDelete = productsToDelete.map(p => p.id);

            const { error } = await supabaseClient.from('productos').delete().in('id', productIdsToDelete);
            
            if (error) {
                showToast('Error al eliminar: ' + error.message);
            } else {
                showToast(`Categoría "${category}" y sus productos eliminados.`);
            }

            // The real-time listener will handle the UI update.
            // For a snappier feel, we can also update locally, but the listener is the source of truth.
            allProducts = allProducts.filter(p => p.category !== category);
            localStorage.setItem('products', JSON.stringify(allProducts));
            renderCategoryManagementList();
            renderProductManagementList();
            filterProducts(); 
            renderCategoryFilters();
        }

        function openProductForm(productId = null) {
            const form = document.getElementById('product-form'); form.reset();
            const title = document.getElementById('product-form-title');
            const deleteBtn = document.getElementById('delete-product-btn');

            let datalist = document.getElementById('category-list');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'category-list';
                document.body.appendChild(datalist);
            }
            const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
            datalist.innerHTML = categories.map(cat => `<option value="${cat}"></option>`).join('');

            if (productId) {
                const p = allProducts.find(p => p.id === productId);
                title.textContent = 'Editar Producto'; deleteBtn.classList.remove('hidden');
                document.getElementById('product-id').value = p.id; document.getElementById('product-name').value = p.name;
                document.getElementById('product-category').value = p.category; document.getElementById('product-price').value = p.price;
                document.getElementById('product-stock').value = p.stock; document.getElementById('product-ideal_stock').value = p.ideal_stock || 0;
                document.getElementById('product-unit').value = p.unit; document.getElementById('product-image').value = p.image; document.getElementById('product-description').value = p.description || '';
                document.getElementById('product-is_service').checked = p.is_service; document.getElementById('product-sold_by_weight').checked = p.sold_by_weight;
                document.getElementById('product-sold_by_length').checked = p.sold_by_length; document.getElementById('product-allow_manual_price').checked = p.allow_manual_price;
            } else {
                title.textContent = 'Crear Producto'; deleteBtn.classList.add('hidden');
                document.getElementById('product-id').value = '';
            }
            openModal('product-form-modal');
        }
        
        function lockUIBySession() {
            const locked = !session;
            // Update the auth icon colour and shape depending on sign‑in status.
            DOM.authIcon.classList.toggle('text-green-500', !!session);
            DOM.authIcon.innerHTML = session ?
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />` :
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />`;
            // Toggle visibility of logout button and disable/enable certain actions.
            document.getElementById('logout-button').classList.toggle('hidden', locked);
            ['btn-finalize', 'btn-wa', 'btn-summary', 'btn-manage-products', 'btn-analyze-sales'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = locked;
            });
            // Update the user email label.  If there is a stored email (userEmail),
            // populate the span and show it; otherwise hide it.  Also set the
            // tooltip of the auth button for accessibility.
            const emailLabel = document.getElementById('user-email-label');
            if (!locked && userEmail) {
                emailLabel.textContent = userEmail;
                emailLabel.classList.remove('hidden');
                DOM.authButton.setAttribute('title', userEmail);
            } else {
                emailLabel.textContent = '';
                emailLabel.classList.add('hidden');
                DOM.authButton.setAttribute('title', '');
            }
        }
        
        function buildTicket(cartData, rate) {
            let ticket = '--- TICKET DE VENTA ---\n\n'; let totalUSD = 0;
            cartData.forEach(item => {
                const subtotal = item.price * item.quantity; totalUSD += subtotal;
                ticket += `${item.name}\n  ${item.quantity} ${item.unit} x ${formatCurrency(item.price)} = ${formatCurrency(subtotal)}\n`;
            });
            ticket += '\n--------------------\n'; ticket += `TOTAL USD: ${formatCurrency(totalUSD)}\n`;
            ticket += `TOTAL Bs: ${formatCurrency(totalUSD * rate, 'BS')} (Tasa: ${rate})\n`;
            ticket += `\nFecha: ${new Date().toLocaleString('es-VE')}`;
            return ticket;
        }

        async function callGemini(prompt) {
            document.getElementById('gemini-modal-content').innerHTML = `<div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-500"></div></div>`;
            openModal('gemini-modal');
            const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorBody = await response.json(); throw new Error(`API Error: ${response.status} - ${errorBody.error.message}`); }
                const result = await response.json(); const candidate = result.candidates?.[0];
                if (candidate?.content?.parts?.[0]?.text) { return candidate.content.parts[0].text; }
                else { throw new Error("No se recibió contenido de la API de Gemini."); }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                document.getElementById('gemini-modal-content').innerHTML = `<p class="text-red-500">Ocurrió un error.</p><p class="text-xs mt-2">${error.message}</p>`;
                return null;
            }
        }
        
        async function analyzeDailySales() {
            if(!session) { showToast("Debes iniciar sesión para esta función."); return; }
            document.getElementById('gemini-modal-title').textContent = '✨ Análisis de Ventas del Día';
            document.getElementById('gemini-modal-footer').innerHTML = `<button type="button" class="btn-close-modal btn btn-secondary">Cerrar</button>`;
            try {
                const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
                const { data: sales, error: salesError } = await supabaseClient.from('ventas').select('id, total_usd').gte('created_at', startOfDay.toISOString());
                if (salesError) throw salesError;
                if (!sales || sales.length === 0) { showToast('No hay ventas hoy para analizar.'); return; }
                const saleIds = sales.map(s => s.id);
                const { data: items, error: itemsError } = await supabaseClient.from('venta_items').select('producto_id, quantity, price').in('venta_id', saleIds);
                if (itemsError) throw itemsError; if (!items || items.length === 0) { showToast('No se encontraron productos vendidos hoy.'); return; }

                const productSales = items.reduce((acc, item) => {
                    const productName = (allProducts.find(p => p.id === item.producto_id) || { name: 'Desconocido' }).name;
                    if (!acc[productName]) acc[productName] = { quantity: 0, revenue: 0 };
                    acc[productName].quantity += item.quantity; acc[productName].revenue += item.quantity * item.price;
                    return acc;
                }, {});
                let salesSummary = 'Productos vendidos hoy:\n';
                for (const name in productSales) { salesSummary += `- ${name}: ${productSales[name].quantity.toFixed(2)} unidades, $${productSales[name].revenue.toFixed(2)} en ingresos.\n`; }
                const totalRevenue = sales.reduce((sum, s) => sum + s.total_usd, 0);
                salesSummary += `\nIngresos totales del día: $${totalRevenue.toFixed(2)}.`;
                const prompt = `Eres un asesor de negocios. Analiza el siguiente resumen de ventas del día. Proporciona un análisis breve y 3 recomendaciones claras y accionables en formato de lista. El tono debe ser optimista y motivador.\n\nResumen de Ventas:\n${salesSummary}\n\nAnálisis y Recomendaciones:`;
                const analysis = await callGemini(prompt);
                if (analysis) {
                    const geminiModalContent = document.getElementById('gemini-modal-content');
                    geminiModalContent.innerHTML = analysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/(\n\s*-\s)/g, '<br> &bull; ').replace(/\n/g, '<br>');
                }
            } catch (error) {
                console.error("Error analyzing sales:", error); showToast("Error al analizar las ventas: " + error.message); closeModal();
            }
        }

        const __offlineQueue = (function(){
            const KEY = 'offlineQueueV1';
            const load = () => { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } };
            const save = q => localStorage.setItem(KEY, JSON.stringify(q));
            
            async function process(){
                if(!navigator.onLine || !window.supabaseClient) return;
                const { data:{ session } } = await supabaseClient.auth.getSession();
                if(!session) return;
                const q = load();
                if(!q.length) return;
                
                showToast('Sincronizando ventas offline...');
                const next = [];
                for(const job of q){
                    try {
                        if(job.type === 'venta'){
                            const { error:e1 } = await supabaseClient.from('ventas').insert([job.venta]); if(e1) throw e1;
                            if(job.items?.length){ const { error:e2 } = await supabaseClient.from('venta_items').insert(job.items); if(e2) throw e2; }
                            for(const upd of (job.stockUpdates||[])){
                                const { error:e3 } = await supabaseClient.rpc('decrement_stock', { product_id: upd.id, decrement_value: upd.quantityToDecrement });
                                if(e3) throw e3;
                            }
                        } else if(job.type === 'upsert_products' && job.rows?.length){
                            const { error:e4 } = await supabaseClient.from('productos').upsert(job.rows, { onConflict:'id' });
                            if(e4) throw e4;
                        }
                    } catch(err) {
                        console.error('Offline job failed, re-queuing:', err);
                        next.push(job);
                    }
                }
                save(next);
                if(next.length < q.length) showToast('Sincronización completada.');
            }
            
            function start() {
                window.addEventListener('online', process);
                if (window.supabaseClient) supabaseClient.auth.onAuthStateChange((event) => { if (event === 'SIGNED_IN') process(); });
                setInterval(process, 30000);
            }
            
            return { enqueue(job){ const q = load(); q.push(job); save(q); }, start };
        })();
        
        async function ensureProductsSynced(){
            if(!session) return;
            const { count, error } = await supabaseClient.from('productos').select('*', { head: true, count: 'exact' });
            if(error || (count || 0) > 0) return;

            showToast('Sincronizando catálogo inicial...');
            const payload = window.products.map(p=>({
                id: p.id, name: p.name, category: p.category, description: p.description, price: p.price, stock: p.stock,
                ideal_stock: p.ideal_stock, unit: p.unit, is_service: p.is_service, sold_by_weight: p.sold_by_weight, sold_by_length: p.sold_by_length,
                allow_manual_price: p.allow_manual_price, image: p.image
            }));
            
            const { error: upErr } = await supabaseClient.from('productos').upsert(payload, { onConflict: 'id' });
            if(upErr) {
                __offlineQueue.enqueue({ type:'upsert_products', rows: payload });
                showToast('Error de conexión. Se sincronizará el catálogo más tarde.');
            } else {
                showToast('Catálogo inicial sincronizado.');
                allProducts = payload; renderProducts(); renderCategoryFilters();
            }
        }
        
        async function recordSale(paymentMethods = {}){
            const ventaId = 'v_' + Date.now();
            const totalUSD = window.cart.reduce((s,it)=> s + (it.price * it.quantity), 0);
            const venta = { id: ventaId, total_usd: totalUSD, exchange_rate: window.exchangeRate, items: window.cart.length, payment_methods: paymentMethods, seller_id: session.user.id };
            const items = window.cart.map(it=>({ venta_id: ventaId, producto_id: it.id, quantity: it.quantity, price: it.price }));
            
            const { error:e1 } = await supabaseClient.from('ventas').insert([venta]);
            if(e1) throw e1;
            
            if(items.length){ const { error:e2 } = await supabaseClient.from('venta_items').insert(items); if(e2) throw e2; }
            
            for(const it of window.cart){ if(!it.is_service) await supabaseClient.rpc('decrement_stock', { product_id: it.id, decrement_value: it.quantity }); }
        }

        async function safeRecordSale(paymentMethods) {
            try {
                // Ensure we have a session or restore it from local storage for offline sales
                if (!session) {
                    const storedId = localStorage.getItem('userId');
                    if (storedId) {
                        session = { user: { id: storedId } };
                    } else {
                        throw new Error('Debes iniciar sesión para esta acción');
                    }
                }
                await recordSale(paymentMethods);
                return true;
            } catch(e) {
                console.warn('Online sale recording failed, enqueuing offline.', e);
                try {
                    const sellerId = session && session.user ? session.user.id : localStorage.getItem('userId');
                    if (!sellerId) throw new Error('Sin identificador de usuario para venta offline');
                    const ventaId = 'v_off_' + Date.now();
                    const totalUSD = window.cart.reduce((s,it)=> s + (it.price*it.quantity), 0);
                    const venta = { id: ventaId, total_usd: totalUSD, exchange_rate: window.exchangeRate, items: window.cart.length, payment_methods: paymentMethods, seller_id: sellerId };
                    const items = window.cart.map(it=>({ venta_id: ventaId, producto_id: it.id, quantity: it.quantity, price: it.price }));
                    const stockUpdates = window.cart.filter(it=>!it.is_service).map(it=>({ id: it.id, quantityToDecrement: it.quantity }));
                    __offlineQueue.enqueue({ type:'venta', venta, items, stockUpdates });

                    // Instant stock update in local state
                    window.cart.forEach(cartItem => {
                        if (!cartItem.is_service) {
                            const productIndex = allProducts.findIndex(p => p.id === cartItem.id);
                            if (productIndex > -1) {
                                allProducts[productIndex].stock -= cartItem.quantity;
                            }
                        }
                    });
                    localStorage.setItem('products', JSON.stringify(allProducts));
                    filterProducts();

                    showToast('Venta guardada offline. Se sincronizará automáticamente.');
                    return true;
                } catch(e2) {
                    console.error('Failed to enqueue offline sale:', e2);
                    showToast('No se pudo registrar la venta ni guardarla offline.', 5000);
                    return false;
                }
            }
        }
        
        function waChoice(){
            return new Promise(resolve=>{
                const wrap=document.createElement('div');
                wrap.className = 'modal-overlay-bg fixed inset-0 flex items-center justify-center z-50';
                wrap.innerHTML=`<div class="bg-secondary rounded-lg p-4 w-full max-w-xs shadow-xl">
                    <h3 class="font-bold text-lg mb-2">Enviar por WhatsApp</h3>
                    <p class="text-sm mb-4 text-text-secondary">¿Cómo quieres enviar este ticket?</p>
                    <div class="flex flex-col gap-2">
                        <button id="wa-presupuesto" class="btn btn-secondary w-full">Solo Presupuesto</button>
                        <button id="wa-venta" class="btn btn-primary w-full">Finalizar Venta y Enviar</button>
                    </div>
                    <div class="mt-4 text-center"><button id="wa-cancel" class="btn btn-text text-sm">Cancelar</button></div>
                </div>`;
                document.body.appendChild(wrap);
                const close=v=>{ wrap.remove(); resolve(v); };
                wrap.querySelector('#wa-presupuesto').onclick=()=>close('presupuesto');
                wrap.querySelector('#wa-venta').onclick=()=>close('venta');
                wrap.querySelector('#wa-cancel').onclick=()=>close(null);
            });
        }

        async function exportSalesSummary() {
            if (!session) { showToast('Debes iniciar sesión para ver el resumen.'); return; }

            const startOfDay = new Date();
            startOfDay.setHours(0, 0, 0, 0);

            try {
                const { data: sales, error } = await supabaseClient
                    .from('ventas')
                    .select('*, venta_items(*, productos(name))')
                    .gte('created_at', startOfDay.toISOString())
                    .order('created_at', { ascending: false });

                if (error) throw error;
                if (!sales || sales.length === 0) {
                    showToast('No hay ventas registradas hoy.');
                    return;
                }

                let totalDayUSD = 0;
                let reportHtml = '';

                sales.forEach(sale => {
                    totalDayUSD += sale.total_usd;
                    (sale.venta_items || []).forEach(item => {
                        const productName = item.productos ? item.productos.name : 'Producto Eliminado';
                        const subTotalUSD = item.quantity * item.price;
                        reportHtml += `
                            <tr>
                                <td>${new Date(sale.created_at).toLocaleTimeString('es-VE')}</td>
                                <td>${productName}</td>
                                <td class="text-right">${item.quantity}</td>
                                <td class="text-right">${formatCurrency(item.price)}</td>
                                <td class="text-right">${formatCurrency(subTotalUSD)}</td>
                            </tr>
                        `;
                    });
                });

                const fullHtml = `
                    <html>
                    <head>
                        <title>Resumen de Ventas - ${new Date().toLocaleDateString('es-VE')}</title>
                        <style>
                            body { font-family: sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; }
                            th { background-color: #f2f2f2; text-align: left; }
                            .text-right { text-align: right; }
                            h1, h2 { text-align: center; }
                            .total-row { font-weight: bold; background-color: #f9f9f9; }
                        </style>
                    </head>
                    <body>
                        <h1>Resumen de Ventas</h1>
                        <h2>${new Date().toLocaleDateString('es-VE')}</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Producto</th>
                                    <th class="text-right">Cantidad</th>
                                    <th class="text-right">Precio Unit.</th>
                                    <th class="text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportHtml}
                                <tr class="total-row">
                                    <td colspan="4">TOTAL DEL DÍA</td>
                                    <td class="text-right">${formatCurrency(totalDayUSD)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;

                const win = window.open('', '_blank');
                win.document.write(fullHtml);
                win.document.close();
                win.print();

            } catch (error) {
                console.error("Error creating sales summary:", error);
                showToast("Error al generar el resumen: " + error.message, 5000);
            }
        }
        
        // Nueva versión de exportSalesSummary con rango de fechas (1, 7, 15 o 30 días) y filtro por método de pago.  Esta función utiliza prompts para solicitar parámetros al administrador.
        async function exportSalesSummaryCustom() {
            if (!session) { showToast('Debes iniciar sesión para ver el resumen.'); return; }
            const daysInput = prompt('Mostrar ventas de los últimos días (elige 1, 7, 15 o 30):', '1');
            if (daysInput === null) return;
            let days = parseInt(daysInput, 10);
            if (isNaN(days) || ![1, 7, 15, 30].includes(days)) {
                days = 1;
            }
            let paymentFilter = prompt('Filtrar por tipo de pago (opcional). Usa valores como "efectivo_usd", "efectivo_bs", "zelle", "tarjeta", "pago_movil". Deja vacío para incluir todos:', '');
            if (paymentFilter === null) return;
            paymentFilter = (paymentFilter || '').trim().toLowerCase();
            const startDate = new Date();
            startDate.setHours(0, 0, 0, 0);
            startDate.setDate(startDate.getDate() - (days - 1));
            try {
                const { data: sales, error } = await supabaseClient
                    .from('ventas')
                    .select('*, venta_items(*, productos(name))')
                    .gte('created_at', startDate.toISOString())
                    .order('created_at', { ascending: false });
                if (error) throw error;
                if (!sales || sales.length === 0) {
                    showToast('No hay ventas registradas en el periodo seleccionado.');
                    return;
                }
                let filteredSales = sales;
                if (paymentFilter) {
                    // Permitir coincidencias parciales: por ejemplo, "efectivo" coincidirá con "efectivo_usd" y "efectivo_bs".
                    const normalizedFilter = paymentFilter.toLowerCase();
                    filteredSales = sales.filter(sale => {
                        try {
                            const methods = sale.payment_methods || {};
                            return Object.keys(methods).some(key => key.toLowerCase().includes(normalizedFilter));
                        } catch {
                            return false;
                        }
                    });
                    if (filteredSales.length === 0) {
                        showToast('No hay ventas para el tipo de pago seleccionado.');
                        return;
                    }
                }
                let totalUSD = 0;
                let totalBs = 0;
                let reportHtml = '';
                // Build an object to accumulate totals by payment method.  All
                // payment amounts in payment_methods are recorded in USD, so
                // each method will accumulate a USD sum and its equivalent in
                // bolívares (Bs) using the sale's exchange rate.  Structure:
                // { methodName: { usd: number, bs: number } }
                const paymentTotals = {};
                filteredSales.forEach(sale => {
                    totalUSD += sale.total_usd;
                    // Compute total Bs for the sale using its exchange rate.  If
                    // exchange_rate is null or zero, skip to avoid NaN.
                    if (sale.exchange_rate) {
                        totalBs += sale.total_usd * sale.exchange_rate;
                    }
                    // For each sale, accumulate totals per payment method.  The
                    // payment_methods object has keys corresponding to the method and
                    // values representing the amount in USD or VES.  We'll sum them
                    // here for later reporting.
                    try {
                        const methods = sale.payment_methods || {};
                        Object.keys(methods).forEach(key => {
                            const amount = Number(methods[key] || 0);
                            const rate   = sale.exchange_rate || 0;
                            if (!paymentTotals[key]) paymentTotals[key] = { usd: 0, bs: 0 };
                            // Since payment amounts are registered in USD, accumulate
                            // directly to USD and convert to bolívares for Bs totals.
                            paymentTotals[key].usd += amount;
                            paymentTotals[key].bs  += rate ? amount * rate : 0;
                        });
                    } catch {}
                    // Build the human readable label for this sale.  Join all keys.
                    let paymentLabel = 'Desconocido';
                    try {
                        const keys = Object.keys(sale.payment_methods || {});
                        if (keys.length > 0) {
                            paymentLabel = keys.join(', ');
                        }
                    } catch {}
                    (sale.venta_items || []).forEach(item => {
                        const productName = item.productos ? item.productos.name : 'Producto Eliminado';
                        const subTotalUSD = item.quantity * item.price;
                        // Compute the subtotal in bolívares using the sale's exchange rate.  If
                        // no rate is available, default to 0 for Bs.
                        const subTotalBs = sale.exchange_rate ? subTotalUSD * sale.exchange_rate : 0;
                        reportHtml += `
                            <tr>
                                <td>${new Date(sale.created_at).toLocaleString('es-VE')}</td>
                                <td>${productName}</td>
                                <td class="text-right">${item.quantity}</td>
                                <td class="text-right">${formatCurrency(subTotalUSD)}</td>
                                <td class="text-right">${formatCurrency(subTotalBs, 'VES')}</td>
                                <td>${paymentLabel}</td>
                            </tr>
                        `;
                    });
                });
                const endDate = new Date();
                const rangeLabel = `${startDate.toLocaleDateString('es-VE')} – ${endDate.toLocaleDateString('es-VE')}`;
                // Build a summary table of totals by payment method.  If there
                // are any paymentTotals recorded, create a table listing each
                // method and its aggregated amount.  Use the existing
                // formatCurrency helper; determine currency based on the method
                // name (if it contains "bs" treat as VES, otherwise USD).
                let paymentTotalsHtml = '';
                const paymentEntries = Object.entries(paymentTotals);
                if (paymentEntries.length > 0) {
                    // Compute general totals across all payment methods by summing
                    // USD and Bs values separately.
                    const generalTotals = paymentEntries.reduce((acc, [, totals]) => {
                        acc.usd += totals.usd;
                        acc.bs  += totals.bs;
                        return acc;
                    }, { usd: 0, bs: 0 });
                    paymentTotalsHtml = `
                        <h3>Totales por Tipo de Pago</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Tipo de Pago</th>
                                    <th>Total USD</th>
                                    <th>Total Bs</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${paymentEntries.map(([method, totals]) => {
                                    return `<tr><td>${method}</td><td>${formatCurrency(totals.usd)}</td><td>${formatCurrency(totals.bs, 'VES')}</td></tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                        <p><strong>Total General USD:</strong> ${formatCurrency(generalTotals.usd)}</p>
                        <p><strong>Total General Bs:</strong> ${formatCurrency(generalTotals.bs, 'VES')}</p>
                    `;
                }

                const fullHtml = `
                    <html>
                    <head>
                        <title>Resumen de Ventas - ${rangeLabel}</title>
                        <style>
                            body { font-family: sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; }
                            th { background-color: #f2f2f2; text-align: left; }
                            .text-right { text-align: right; }
                            h1, h2 { text-align: center; }
                            .total-row { font-weight: bold; background-color: #f9f9f9; }
                        </style>
                    </head>
                    <body>
                        <h1>Resumen de Ventas</h1>
                        <h2>${rangeLabel}</h2>
                        ${paymentFilter ? `<p><strong>Tipo de pago:</strong> ${paymentFilter}</p>` : ''}
                         <table>
                             <thead>
                                 <tr>
                                     <th>Fecha y Hora</th>
                                     <th>Producto</th>
                                     <th class="text-right">Cantidad</th>
                                     <th class="text-right">Subtotal USD</th>
                                     <th class="text-right">Subtotal Bs</th>
                                     <th>Pago(s)</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 ${reportHtml}
                                 <tr class="total-row">
                                     <td colspan="3">TOTAL PERIODO</td>
                                     <td class="text-right">${formatCurrency(totalUSD)}</td>
                                     <td class="text-right">${formatCurrency(totalBs, 'VES')}</td>
                                     <td></td>
                                 </tr>
                             </tbody>
                         </table>
                        ${paymentTotalsHtml}
                    </body>
                    </html>
                `;
                const win = window.open('', '_blank');
                if (!win) {
                    showToast('No se pudo abrir la ventana para el resumen.');
                    return;
                }
                win.document.write(fullHtml);
                win.document.close();
                win.print();
            } catch (error) {
                console.error('Error creando resumen de ventas:', error);
                showToast('Error al generar el resumen: ' + (error.message || ''), 5000);
            }
        }

        async function syncProductsFromSupabase() {
            if (!navigator.onLine) {
                console.log("Offline mode: Skipping Supabase sync.");
                return;
            }
            try {
                const { data, error } = await supabaseClient.from('productos').select('*').order('name');
                if (error) throw error;
                allProducts = data;
                localStorage.setItem('products', JSON.stringify(allProducts));
                renderProducts();
                renderCategoryFilters();
                await ensureProductsSynced();
            } catch(error) {
                console.error('Error syncing products from Supabase:', error);
            }
        }

        function loadProductsFromLocal() {
            try {
                const localProducts = JSON.parse(localStorage.getItem('products') || '[]');
                if (Array.isArray(localProducts) && localProducts.length > 0) {
                    allProducts = localProducts;
                }
            } catch(e) {
                console.error("Could not load products from local storage", e);
                allProducts = [];
            }
            renderProducts();
            renderCategoryFilters();
        }

        function listenToProductChanges() {
            if (window.productChangesSubscription) {
                window.productChangesSubscription.unsubscribe();
            }
            
            window.productChangesSubscription = supabaseClient
                .channel('public:productos')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'productos' }, payload => {
                    console.log('Realtime change received!', payload);
                    const { eventType, new: newRecord, old: oldRecord } = payload;
                    
                    if (eventType === 'INSERT') {
                        allProducts.push(newRecord);
                    }
                    if (eventType === 'UPDATE') {
                        const index = allProducts.findIndex(p => p.id === newRecord.id);
                        if (index > -1) allProducts[index] = newRecord;
                    }
                    if (eventType === 'DELETE') {
                        allProducts = allProducts.filter(p => p.id !== oldRecord.id);
                    }

                    localStorage.setItem('products', JSON.stringify(allProducts));
                    filterProducts();
                    renderCategoryFilters();

                    if (currentModal === 'product-management-modal') {
                        renderProductManagementList();
                        renderCategoryManagementList();
                    }
                })
                .subscribe();
        }

        async function initializeApp() {
            Theme.apply(localStorage.getItem('theme') || 'light');
            fetchAndUpdateExchangeRate(); 
            setInterval(fetchAndUpdateExchangeRate, 3600000);
            
            loadProductsFromLocal();

            const { data: { session: initialSession } } = await supabaseClient.auth.getSession();
            session = initialSession;
            // If we have a session with an email, store it immediately.  This
            // allows the email to persist in localStorage for offline use.  If
            // there is no session yet, we will attempt to restore it from
            // localStorage below.
            if (session && session.user && session.user.email) {
                userEmail = session.user.email;
                try { localStorage.setItem('userEmail', userEmail); } catch {}
            }
            // If there is no active session (offline or not logged in), attempt
            // to restore the previous user id and role from localStorage so
            // the app remains functional offline.  This allows recording
            // offline sales even after a refresh without re‑authenticating.
            if (!session) {
                const storedId = localStorage.getItem('userId');
                const storedRole = localStorage.getItem('userRole');
                const storedEmail = localStorage.getItem('userEmail');
                if (storedId) {
                    session = { user: { id: storedId } };
                    userRole = storedRole || null;
                    userEmail = storedEmail || null;
                }
            }
            lockUIBySession();
            // Fetch the role from Supabase only if we have a session and
            // online connectivity.  Otherwise fallback to stored role.
            if (session && navigator.onLine) {
                await fetchUserRole();
            }
            if (!userRole) {
                try { userRole = localStorage.getItem('userRole') || null; } catch {}
            }
            updateUIByRole();
            await syncProductsFromSupabase();
            listenToProductChanges();

            supabaseClient.auth.onAuthStateChange((_event, newSession) => { 
                const sessionChanged = session?.user?.id !== newSession?.user?.id;
                session = newSession;
                // Update the stored email whenever the session changes.  When
                // logging in, store the new email; when logging out, clear it.
                if (session && session.user && session.user.email) {
                    userEmail = session.user.email;
                    try { localStorage.setItem('userEmail', userEmail); } catch {}
                } else {
                    userEmail = null;
                    try { localStorage.removeItem('userEmail'); } catch {}
                }
                lockUIBySession();
                // Refresh user role and update UI whenever the auth session changes
                if (session) {
                    fetchUserRole().then(updateUIByRole);
                } else {
                    userRole = null;
                    updateUIByRole();
                }
                if (sessionChanged && newSession) {
                    // If a different user just signed in, resync products and subscribe to changes
                    syncProductsFromSupabase();
                    listenToProductChanges();
                } else if (!newSession && sessionChanged) {
                    // If the user just signed out, resync products for public catalog and keep listening
                    syncProductsFromSupabase();
                    listenToProductChanges();
                }
            });

            window.addEventListener('beforeinstallprompt', (event) => {
                event.preventDefault();
                deferredInstallPrompt = event;
                DOM.installAppBtn.classList.remove('hidden');
            });

            DOM.installAppBtn.addEventListener('click', async () => {
                if (deferredInstallPrompt) {
                    deferredInstallPrompt.prompt();
                    await deferredInstallPrompt.userChoice;
                    deferredInstallPrompt = null;
                    DOM.installAppBtn.classList.add('hidden');
                }
            });

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then(reg => {
                        console.log('Service worker registered!', reg);
                    }).catch(err => {
                        console.log('Service worker registration failed: ', err);
                    });
                });
            }
            __offlineQueue.start();
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { document.getElementById('config-error').classList.remove('hidden'); return; }
            window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const closeCartDrawer = () => DOM.cartDrawer.classList.replace('open', 'closed');

            DOM.themeToggleBtn.addEventListener('click', () => Theme.toggle());
            DOM.viewToggleBtn.addEventListener('click', () => {
                DOM.productGrid.classList.toggle('list-view');
                DOM.viewToggleBtn.innerHTML = DOM.productGrid.classList.contains('list-view') ? '<i class="fas fa-th-large"></i>' : '<i class="fas fa-grip-vertical"></i>';
            });
            DOM.searchInput.addEventListener('input', filterProducts);
            DOM.authButton.addEventListener('click', () => openModal('auth-modal'));
            document.getElementById('cart-button').addEventListener('click', () => DOM.cartDrawer.classList.replace('closed', 'open'));
            document.getElementById('close-cart-button').addEventListener('click', closeCartDrawer);
            DOM.modalContainer.addEventListener('click', e => { if (e.target === DOM.modalContainer || e.target.closest('.btn-close-modal')) closeModal(); });
            
            DOM.bcvToggleBtn.addEventListener('click', () => {
                isBcvAuto = !isBcvAuto;
                DOM.exchangeRateInput.readOnly = isBcvAuto;
                DOM.exchangeRateInput.classList.toggle('bg-gray-200', isBcvAuto);
                DOM.exchangeRateInput.classList.toggle('dark:bg-gray-600', isBcvAuto);
                DOM.exchangeRateInput.classList.toggle('bg-white', !isBcvAuto);
                DOM.exchangeRateInput.classList.toggle('dark:bg-gray-700', !isBcvAuto);
                DOM.bcvToggleBtn.classList.toggle('text-green-500', isBcvAuto);
                if (isBcvAuto) {
                    fetchAndUpdateExchangeRate();
                } else {
                     document.getElementById('rate-last-update').textContent = 'Entrada manual';
                }
            });
            DOM.exchangeRateInput.addEventListener('input', () => {
                if (!isBcvAuto) { renderCart(); filterProducts(); }
            });

            document.getElementById('login-form').addEventListener('submit', async e => {
                e.preventDefault();
                const { error } = await supabaseClient.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value });
                if (error) showToast('Error: ' + error.message); else { showToast('Sesión iniciada.'); closeModal(); }
            });
            document.getElementById('logout-button').addEventListener('click', async () => {
                if (await showConfirmation('¿Seguro que quieres cerrar sesión?')) {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) showToast('Error: ' + error.message); else { showToast('Sesión cerrada.'); closeModal(); }
                }
            });

            document.getElementById('btn-manage-products').addEventListener('click', () => { 
                renderProductManagementList(); 
                renderCategoryManagementList();
                switchManagementTab('products');
                openModal('product-management-modal'); 
            });

            document.getElementById('tab-btn-products').addEventListener('click', () => switchManagementTab('products'));
            document.getElementById('tab-btn-categories').addEventListener('click', () => switchManagementTab('categories'));

            document.getElementById('add-new-product-btn').addEventListener('click', () => openProductForm());
            document.getElementById('upload-json-btn').addEventListener('click', () => document.getElementById('json-upload-input').click());

            // Maneja la carga de un archivo JSON que contiene productos. Este flujo
            // reemplaza por completo los productos existentes: al seleccionar un
            // archivo, se lee su contenido, se valida que sea un arreglo de
            // objetos y se solicita confirmación al usuario. Si confirma, se
            // eliminan todos los registros de la tabla "productos" y se insertan
            // los nuevos elementos. Los IDs se generan si están ausentes para
            // evitar duplicados. Finalmente, la lista local y el filtro de
            // categorías se actualizan para reflejar el nuevo catálogo.
            const jsonUploadInput = document.getElementById('json-upload-input');
            if (jsonUploadInput) {
                jsonUploadInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    try {
                        const text = await file.text();
                        const imported = JSON.parse(text);
                        if (!Array.isArray(imported)) {
                            showToast('El JSON debe contener un arreglo de productos');
                            event.target.value = '';
                            return;
                        }
                        // Solicita confirmación al usuario antes de eliminar e importar
                        if (!confirm('Esto reemplazará todos los productos existentes. ¿Desea continuar?')) {
                            event.target.value = '';
                            return;
                        }
                        // Elimina todos los productos actuales (sólo administradores tienen permiso)
                        const deleteRes = await supabaseClient.from('productos').delete().neq('id', '');
                        if (deleteRes.error) {
                            console.error(deleteRes.error);
                            showToast('Error eliminando productos existentes');
                            event.target.value = '';
                            return;
                        }
                        // Construye lista sanitizada de productos; genera ID si falta y asigna valores por defecto
                        const now = Date.now();
                        const sanitized = imported.map((prod, idx) => {
                            // Copiar sólo campos conocidos
                            const name = prod.name || '';
                            let id = prod.id;
                            if (!id || typeof id !== 'string') {
                                id = `prod_${slugify(name)}_${now}_${idx}`;
                            }
                            return {
                                id,
                                name,
                                description: prod.description || '',
                                category: prod.category || '',
                                price: typeof prod.price === 'number' ? prod.price : 0,
                                stock: typeof prod.stock === 'number' ? prod.stock : 0,
                                ideal_stock: typeof prod.ideal_stock === 'number' ? prod.ideal_stock : 0,
                                unit: prod.unit || 'Unidad',
                                is_service: !!prod.is_service,
                                sold_by_weight: !!prod.sold_by_weight,
                                sold_by_length: !!prod.sold_by_length,
                                allow_manual_price: !!prod.allow_manual_price,
                                image: prod.image || '',
                                created_at: prod.created_at || new Date().toISOString()
                            };
                        });
                        // Inserta productos con upsert para evitar conflictos
                        const insertRes = await supabaseClient.from('productos').upsert(sanitized);
                        if (insertRes.error) {
                            console.error(insertRes.error);
                            showToast('Error importando productos');
                            event.target.value = '';
                            return;
                        }
                        // Actualiza local
                        allProducts = sanitized;
                        localStorage.setItem('products', JSON.stringify(allProducts));
                        renderProducts();
                        renderCategoryFilters();
                        showToast('Productos importados correctamente');
                        // Limpia el input para permitir cargar nuevamente el mismo archivo si se desea
                        event.target.value = '';
                    } catch (err) {
                        console.error(err);
                        showToast('Error procesando el archivo JSON');
                        event.target.value = '';
                    }
                });
            }

            // Botón que abre el formulario para crear vendedores (sólo visible para administradores)
            const createSellerBtn = document.getElementById('btn-create-seller');
            if (createSellerBtn) {
                createSellerBtn.addEventListener('click', () => {
                    openModal('create-seller-modal');
                });
            }

            // Enviar el formulario de creación de vendedor. Envía una petición a la función serverless
            // /.netlify/functions/create-seller con email y contraseña. Muestra mensajes según el resultado.
            const createSellerForm = document.getElementById('create-seller-form');
            if (createSellerForm) {
                createSellerForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const email    = document.getElementById('seller-email').value;
                    const password = document.getElementById('seller-password').value;
                    if (!email || !password) {
                        showToast('Email y contraseña son obligatorios');
                        return;
                    }
                    try {
                        const response = await fetch('/.netlify/functions/create-seller', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });
                        // Intenta leer la respuesta como texto primero. Algunas respuestas de error de Netlify
                        // pueden no devolver JSON válido.
                        const text = await response.text();
                        let result;
                        try {
                            result = JSON.parse(text);
                        } catch (parseErr) {
                            result = { message: text };
                        }
                        if (response.ok) {
                            showToast(result.message || 'Vendedor creado correctamente');
                            closeModal();
                        } else {
                            showToast(result.message || 'Error al crear vendedor');
                        }
                    } catch (err) {
                        showToast(err.message || 'Error de red');
                    }
                });
            }

            // Vincula el buscador de gestión de productos para filtrar a medida que se escribe
            const productManageSearch = document.getElementById('product-manage-search');
            if (productManageSearch) {
                productManageSearch.addEventListener('input', () => {
                    renderProductManagementList();
                });
            }

            // ----------------------------------------------------------------------
            // Gestión de vendedores
            // Lista global de vendedores. Se cargará cuando se abra el modal de gestión.
            let sellerList = [];
            async function loadSellerList() {
                try {
                    const response = await fetch('/.netlify/functions/manage-seller');
                    const text = await response.text();
                    let sellers;
                    try { sellers = JSON.parse(text); } catch { sellers = []; }
                    if (response.ok) {
                        sellerList = Array.isArray(sellers) ? sellers : [];
                        renderSellerList();
                    } else {
                        showToast((sellers && sellers.message) || 'Error al obtener vendedores');
                    }
                } catch (err) {
                    showToast(err.message || 'Error al obtener vendedores');
                }
            }
            function renderSellerList() {
                const container = document.getElementById('seller-list-container');
                if (!container) return;
                container.innerHTML = '';
                const searchInput = document.getElementById('seller-search');
                const query = searchInput && searchInput.value ? searchInput.value.trim().toLowerCase() : '';
                const filtered = sellerList.filter(s => s.email && s.email.toLowerCase().includes(query));
                if (filtered.length === 0) {
                    container.innerHTML = '<p class="text-center text-text-secondary p-4">No hay vendedores.</p>';
                    return;
                }
                filtered.forEach(seller => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center border-b border-border-color p-2 last:border-b-0';
                    // Only render the delete button.  Editing seller passwords has
                    // been disabled due to recurring errors with the Supabase
                    // update endpoint.  Administrators can still create and
                    // remove sellers via the other controls.
                    row.innerHTML = `
                        <div><p class="font-medium">${seller.email}</p></div>
                        <div class="flex gap-2">
                            <button class="delete-seller-btn btn btn-danger text-xs py-1 px-2" data-id="${seller.id}" data-email="${seller.email}">Eliminar</button>
                        </div>`;
                    container.appendChild(row);
                });
                // Attach only the delete handler because editing is disabled.
                container.querySelectorAll('.delete-seller-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteSeller);
                });
            }
            async function handleEditSeller(e) {
                const id = e.currentTarget.dataset.id;
                const email = e.currentTarget.dataset.email;
                const newPass = prompt(`Cambiar contraseña para ${email}:\nIntroduce la nueva contraseña`);
                if (!newPass) return;
                try {
                    const response = await fetch('/.netlify/functions/manage-seller', {
                        // Use PUT when calling the management endpoint.  Our
                        // function supports both PUT and PATCH, but some
                        // deployments may treat PATCH differently and return
                        // errors.  PUT ensures broader compatibility while
                        // still allowing the function to internally use
                        // PATCH against Supabase.
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id, password: newPass })
                    });
                    const text = await response.text();
                    let data;
                    try { data = JSON.parse(text); } catch { data = { message: text }; }
                    if (response.ok) {
                        showToast(data.message || 'Contraseña actualizada');
                    } else {
                        showToast(data.message || 'Error actualizando contraseña');
                    }
                } catch (err) {
                    showToast(err.message || 'Error de red');
                }
            }
            async function handleDeleteSeller(e) {
                const id = e.currentTarget.dataset.id;
                const email = e.currentTarget.dataset.email;
                if (!await showConfirmation(`¿Seguro que quieres eliminar al vendedor ${email}? Esta acción es irreversible.`)) return;
                try {
                    const response = await fetch(`/.netlify/functions/manage-seller?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
                    const text = await response.text();
                    let data;
                    try { data = JSON.parse(text); } catch { data = { message: text }; }
                    if (response.ok) {
                        showToast(data.message || 'Vendedor eliminado');
                        // Remove from local list and re-render
                        sellerList = sellerList.filter(s => s.id !== id);
                        renderSellerList();
                    } else {
                        showToast(data.message || 'Error eliminando vendedor');
                    }
                } catch (err) {
                    showToast(err.message || 'Error de red');
                }
            }
            // Evento para abrir el modal de gestión de vendedores y cargar la lista
            const manageSellersBtn = document.getElementById('btn-manage-sellers');
            if (manageSellersBtn) {
                manageSellersBtn.addEventListener('click', () => {
                    openModal('seller-management-modal');
                    loadSellerList();
                });
            }
            // Filtra vendedores a medida que se escribe
            const sellerSearchInput = document.getElementById('seller-search');
            if (sellerSearchInput) {
                sellerSearchInput.addEventListener('input', () => {
                    renderSellerList();
                });
            }
            
            function exportProductsAsJson() {
                if (!allProducts || allProducts.length === 0) {
                    showToast('No hay productos para exportar.');
                    return;
                }
                const dataStr = JSON.stringify(allProducts, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().slice(0, 10);
                link.download = `productos-${timestamp}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Productos exportados a JSON.');
            }
            document.getElementById('export-json-btn').addEventListener('click', exportProductsAsJson);
            
            document.getElementById('product-form').addEventListener('submit', async e => {
                e.preventDefault(); let id = document.getElementById('product-id').value;
                if (!id) id = 'prod_' + slugify(document.getElementById('product-name').value) + '_' + Date.now();
                const productData = { 
                    id, 
                    name: document.getElementById('product-name').value, 
                    category: document.getElementById('product-category').value, 
                    price: parseFloat(document.getElementById('product-price').value), 
                    stock: parseFloat(document.getElementById('product-stock').value), 
                    ideal_stock: parseFloat(document.getElementById('product-ideal_stock').value) || 0,
                    unit: document.getElementById('product-unit').value, 
                    image: document.getElementById('product-image').value, 
                    description: document.getElementById('product-description').value, 
                    is_service: document.getElementById('product-is_service').checked, 
                    sold_by_weight: document.getElementById('product-sold_by_weight').checked, 
                    sold_by_length: document.getElementById('product-sold_by_length').checked, 
                    allow_manual_price: document.getElementById('product-allow_manual_price').checked 
                };
                const { error } = await supabaseClient.from('productos').upsert(productData, { onConflict: 'id' });
                if(error) { 
                    showToast('Error: ' + error.message); 
                } else { 
                    // The real-time listener will catch the update, but we update locally for instant UI feedback
                    const index = allProducts.findIndex(p => p.id === productData.id);
                    if (index > -1) {
                        allProducts[index] = productData;
                    } else {
                        allProducts.push(productData);
                    }
                    localStorage.setItem('products', JSON.stringify(allProducts));
                    filterProducts();
                    renderCategoryFilters();
                    showToast('Producto guardado.'); 
                    closeModal(); 
                }
            });
            document.getElementById('delete-product-btn').addEventListener('click', async () => {
                const id = document.getElementById('product-id').value;
                if (id && await showConfirmation('¿Seguro que quieres eliminar este producto de forma permanente?')) {
                    const { error } = await supabaseClient.from('productos').delete().eq('id', id);
                    if(error) {
                         showToast('Error: ' + error.message);
                    }
                    
                    // The real-time listener will catch the update, but we update locally for instant UI feedback
                    const index = allProducts.findIndex(p => p.id === id);
                    if (index > -1) allProducts.splice(index, 1);
                    localStorage.setItem('products', JSON.stringify(allProducts));
                    
                    showToast('Producto eliminado.');
                    closeModal();
                    filterProducts();
                    renderCategoryFilters();
                }
            });

            document.getElementById('quantity-modal-confirm').addEventListener('click', () => {
                const p = allProducts.find(p => p.id === document.getElementById('quantity-product-id').value); if(!p) return;
                const quantity = parseFloat(document.getElementById('quantity-input').value); if (isNaN(quantity) || quantity <= 0) { showToast('Cantidad inválida'); return; }
                let price = p.price;
                if (p.allow_manual_price) { const newPrice = parseFloat(document.getElementById('manual-price-input').value); if(isNaN(newPrice) || newPrice < 0){ showToast('Precio inválido'); return; } price = newPrice; }
                addToCart(p, quantity, price); closeModal();
            });

            document.getElementById('btn-finalize').addEventListener('click', () => { if (!session) { showToast('Debes iniciar sesión'); return; } if (window.cart.length === 0) { showToast('El carrito está vacío'); return; } openPaymentModal(); closeCartDrawer(); });
            document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
                const paymentMethods = {};
                document.querySelectorAll('.payment-input').forEach(input => { const amount = parseFloat(input.value) || 0; if (amount > 0) paymentMethods[input.dataset.method] = amount; });
                if (await safeRecordSale(paymentMethods)) { clearCartAndNotify(); closeModal(); }
            });
            document.getElementById('btn-wa').addEventListener('click', async () => {
                if(window.cart.length === 0) { showToast('El carrito está vacío.'); return; }
                const choice = await waChoice();
                if(!choice) return;

                if(choice === 'venta'){
                    if(!session){ showToast('Debes iniciar sesión para registrar una venta.'); return; }
                    openPaymentModal(); 
                } else if(choice === 'presupuesto'){
                    const ticket = buildTicket(window.cart, window.exchangeRate);
                    const url = 'https://wa.me/?text=' + encodeURIComponent(ticket);
                    window.open(url, '_blank');
                }
                closeCartDrawer();
            });
            document.getElementById('btn-summary').addEventListener('click', () => { exportSalesSummaryCustom(); closeCartDrawer(); });
            document.getElementById('btn-analyze-sales').addEventListener('click', () => { analyzeDailySales(); closeCartDrawer(); });

            document.getElementById('generate-description-btn').addEventListener('click', async () => {
                 const name = document.getElementById('product-name').value;
                 if (!name) { showToast('Introduce un nombre de producto.'); return; }
                 const prompt = `Genera una descripción corta y atractiva para un producto en un punto de venta.\n\nNombre: "${name}"\nCategoría: "${document.getElementById('product-category').value}"\n\nDescripción:`;
                 const description = await callGemini(prompt);
                 if (description) {
                     document.getElementById('gemini-modal-content').innerHTML = `<p>${description.replace(/\n/g, '<br>')}</p>`;
                     document.getElementById('gemini-modal-footer').innerHTML = `<button id="use-desc-btn" class="btn btn-primary mr-2">Usar</button><button class="btn-close-modal btn btn-secondary">Cerrar</button>`;
                     document.getElementById('use-desc-btn').onclick = () => { document.getElementById('product-description').value = description; closeModal(); };
                 }
            });

            initializeApp();
        });
    </script>
</body>
</html>
